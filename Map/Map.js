/**
 * wax - 7.0.0dev11 - v6.0.4-113-g6b1c56c
 */
var html4={atype:{NONE:0,URI:1,URI_FRAGMENT:11,SCRIPT:2,STYLE:3,ID:4,IDREF:5,IDREFS:6,GLOBAL_NAME:7,LOCAL_NAME:8,CLASSES:9,FRAME_TARGET:10},ATTRIBS:{"*::class":9,"*::dir":0,"*::id":4,"*::lang":0,"*::onclick":2,"*::ondblclick":2,"*::onkeydown":2,"*::onkeypress":2,"*::onkeyup":2,"*::onload":2,"*::onmousedown":2,"*::onmousemove":2,"*::onmouseout":2,"*::onmouseover":2,"*::onmouseup":2,"*::style":3,"*::title":0,"a::accesskey":0,"a::coords":0,"a::href":1,"a::hreflang":0,"a::name":7,"a::onblur":2,"a::onfocus":2,"a::rel":0,"a::rev":0,"a::shape":0,"a::tabindex":0,"a::target":10,"a::type":0,"area::accesskey":0,"area::alt":0,"area::coords":0,"area::href":1,"area::nohref":0,"area::onblur":2,"area::onfocus":2,"area::shape":0,"area::tabindex":0,"area::target":10,"bdo::dir":0,"blockquote::cite":1,"br::clear":0,"button::accesskey":0,"button::disabled":0,"button::name":8,"button::onblur":2,"button::onfocus":2,"button::tabindex":0,"button::type":0,"button::value":0,"canvas::height":0,"canvas::width":0,"caption::align":0,"col::align":0,"col::char":0,"col::charoff":0,"col::span":0,"col::valign":0,"col::width":0,"colgroup::align":0,"colgroup::char":0,"colgroup::charoff":0,"colgroup::span":0,"colgroup::valign":0,"colgroup::width":0,"del::cite":1,"del::datetime":0,"dir::compact":0,"div::align":0,"dl::compact":0,"font::color":0,"font::face":0,"font::size":0,"form::accept":0,"form::action":1,"form::autocomplete":0,"form::enctype":0,"form::method":0,"form::name":7,"form::onreset":2,"form::onsubmit":2,"form::target":10,"h1::align":0,"h2::align":0,"h3::align":0,"h4::align":0,"h5::align":0,"h6::align":0,"hr::align":0,"hr::noshade":0,"hr::size":0,"hr::width":0,"iframe::align":0,"iframe::frameborder":0,"iframe::height":0,"iframe::marginheight":0,"iframe::marginwidth":0,"iframe::width":0,"img::align":0,"img::alt":0,"img::border":0,"img::height":0,"img::hspace":0,"img::ismap":0,"img::name":7,"img::src":1,"img::usemap":11,"img::vspace":0,"img::width":0,"input::accept":0,"input::accesskey":0,"input::align":0,"input::alt":0,"input::autocomplete":0,"input::checked":0,"input::disabled":0,"input::ismap":0,"input::maxlength":0,"input::name":8,"input::onblur":2,"input::onchange":2,"input::onfocus":2,"input::onselect":2,"input::readonly":0,"input::size":0,"input::src":1,"input::tabindex":0,"input::type":0,"input::usemap":11,"input::value":0,"ins::cite":1,"ins::datetime":0,"label::accesskey":0,"label::for":5,"label::onblur":2,"label::onfocus":2,"legend::accesskey":0,"legend::align":0,"li::type":0,"li::value":0,"map::name":7,"menu::compact":0,"ol::compact":0,"ol::start":0,"ol::type":0,"optgroup::disabled":0,"optgroup::label":0,"option::disabled":0,"option::label":0,"option::selected":0,"option::value":0,"p::align":0,"pre::width":0,"q::cite":1,"select::disabled":0,"select::multiple":0,"select::name":8,"select::onblur":2,"select::onchange":2,"select::onfocus":2,"select::size":0,"select::tabindex":0,"table::align":0,"table::bgcolor":0,"table::border":0,"table::cellpadding":0,"table::cellspacing":0,"table::frame":0,"table::rules":0,"table::summary":0,"table::width":0,"tbody::align":0,"tbody::char":0,"tbody::charoff":0,"tbody::valign":0,"td::abbr":0,"td::align":0,"td::axis":0,"td::bgcolor":0,"td::char":0,"td::charoff":0,"td::colspan":0,"td::headers":6,"td::height":0,"td::nowrap":0,"td::rowspan":0,"td::scope":0,"td::valign":0,"td::width":0,"textarea::accesskey":0,"textarea::cols":0,"textarea::disabled":0,"textarea::name":8,"textarea::onblur":2,"textarea::onchange":2,"textarea::onfocus":2,"textarea::onselect":2,"textarea::readonly":0,"textarea::rows":0,"textarea::tabindex":0,"tfoot::align":0,"tfoot::char":0,"tfoot::charoff":0,"tfoot::valign":0,"th::abbr":0,"th::align":0,"th::axis":0,"th::bgcolor":0,"th::char":0,"th::charoff":0,"th::colspan":0,"th::headers":6,"th::height":0,"th::nowrap":0,"th::rowspan":0,"th::scope":0,"th::valign":0,"th::width":0,"thead::align":0,"thead::char":0,"thead::charoff":0,"thead::valign":0,"tr::align":0,"tr::bgcolor":0,"tr::char":0,"tr::charoff":0,"tr::valign":0,"ul::compact":0,"ul::type":0},eflags:{OPTIONAL_ENDTAG:1,EMPTY:2,CDATA:4,RCDATA:8,UNSAFE:16,FOLDABLE:32,SCRIPT:64,STYLE:128},ELEMENTS:{a:0,abbr:0,acronym:0,address:0,applet:16,area:2,b:0,base:18,basefont:18,bdo:0,big:0,blockquote:0,body:49,br:2,button:0,canvas:0,caption:0,center:0,cite:0,code:0,col:2,colgroup:1,dd:1,del:0,dfn:0,dir:0,div:0,dl:0,dt:1,em:0,fieldset:0,font:0,form:0,frame:18,frameset:16,h1:0,h2:0,h3:0,h4:0,h5:0,h6:0,head:49,hr:2,html:49,i:0,iframe:4,img:2,input:2,ins:0,isindex:18,kbd:0,label:0,legend:0,li:1,link:18,map:0,menu:0,meta:18,nobr:0,noembed:4,noframes:20,noscript:20,object:16,ol:0,optgroup:0,option:1,p:1,param:18,pre:0,q:0,s:0,samp:0,script:84,select:0,small:0,span:0,strike:0,strong:0,style:148,sub:0,sup:0,table:0,tbody:1,td:1,textarea:8,tfoot:1,th:1,thead:1,title:24,tr:1,tt:0,u:0,ul:0,"var":0},ueffects:{NOT_LOADED:0,SAME_DOCUMENT:1,NEW_DOCUMENT:2},URIEFFECTS:{"a::href":2,"area::href":2,"blockquote::cite":0,"body::background":1,"del::cite":0,"form::action":2,"img::src":1,"input::src":1,"ins::cite":0,"q::cite":0},ltypes:{UNSANDBOXED:2,SANDBOXED:1,DATA:0},LOADERTYPES:{"a::href":2,"area::href":2,"blockquote::cite":2,"body::background":1,"del::cite":2,"form::action":2,"img::src":1,"input::src":1,"ins::cite":2,"q::cite":2}},html=function(a){function c(a,b){var d;d=e(b);if(j.hasOwnProperty(d))d=j[d];else{var c=d.match(p);d=c?String.fromCharCode(parseInt(c[1],10)):(c=d.match(l))?String.fromCharCode(parseInt(c[1],16)):""}return d}function f(a){return a.replace(t,c)}function b(a){return a.replace(s,"&amp;").replace(m,"&lt;").replace(v,"&gt;").replace(w,"&#34;").replace(x,"&#61;")}function g(a){return a.replace(i,"&amp;$1").replace(m,"&lt;").replace(v,"&gt;")}function d(b){return function(d,c){var d=String(d),i=null,h=!1,j=[],q=void 0,l=void 0,u=void 0;for(b.startDoc&&b.startDoc(c);d;){var k=d.match(h?y:z),d=d.substring(k[0].length);if(h)if(k[1]){var m=e(k[1]);if(k[2]){k=k[3];switch(k.charCodeAt(0)){case 34:case 39:k=k.substring(1,k.length-1)}k=f(k.replace(r,""))}else k=m;j.push(m,k)}else k[4]&&(void 0!==l&&(u?b.startTag&&b.startTag(q,j,c):b.endTag&&b.endTag(q,c)),u&&l&(a.eflags.CDATA|a.eflags.RCDATA)&&(i=null===i?e(d):i.substring(i.length-d.length),h=i.indexOf("</"+q),0>h&&(h=d.length),h&&(l&a.eflags.CDATA?b.cdata&&b.cdata(d.substring(0,h),c):b.rcdata&&b.rcdata(g(d.substring(0,h)),c),d=d.substring(h))),q=l=u=void 0,j.length=0,h=!1);else k[1]?b.pcdata&&b.pcdata(k[0],c):k[3]?(u=!k[2],h=!0,q=e(k[3]),l=a.ELEMENTS.hasOwnProperty(q)?a.ELEMENTS[q]:void 0):k[4]?b.pcdata&&b.pcdata(k[4],c):k[5]&&b.pcdata&&(m=k[5],b.pcdata("<"===m?"&lt;":">"===m?"&gt;":"&amp;",c))}b.endDoc&&b.endDoc(c)}}function h(c){var i,f;return d({startDoc:function(){i=[];f=!1},startTag:function(d,h,g){if(!f&&a.ELEMENTS.hasOwnProperty(d)){var e=a.ELEMENTS[d];if(!(e&a.eflags.FOLDABLE))if(e&a.eflags.UNSAFE)f=!(e&a.eflags.EMPTY);else if(h=c(d,h)){e&a.eflags.EMPTY||i.push(d);g.push("<",d);d=0;for(e=h.length;d<e;d+=2){var l=h[d],j=h[d+1];null!==j&&void 0!==j&&g.push(" ",l,'="',b(j),'"')}g.push(">")}}},endTag:function(b,d){if(f)f=!1;else if(a.ELEMENTS.hasOwnProperty(b)){var c=a.ELEMENTS[b];if(!(c&(a.eflags.UNSAFE|a.eflags.EMPTY|a.eflags.FOLDABLE))){if(c&a.eflags.OPTIONAL_ENDTAG)for(c=i.length;0<=--c;){var h=i[c];if(h===b)break;if(!(a.ELEMENTS[h]&a.eflags.OPTIONAL_ENDTAG))return}else for(c=i.length;0<=--c&&i[c]!==b;);if(!(0>c)){for(var e=i.length;--e>c;)h=i[e],a.ELEMENTS[h]&a.eflags.OPTIONAL_ENDTAG||d.push("</",h,">");i.length=c;d.push("</",b,">")}}}},pcdata:function(a,b){f||b.push(a)},rcdata:function(a,b){f||b.push(a)},cdata:function(a,b){f||b.push(a)},endDoc:function(a){for(var b=i.length;0<=--b;)a.push("</",i[b],">");i.length=0}})}var e;e=function(a){return a.toLowerCase()};var j={lt:"<",gt:">",amp:"&",nbsp:"\u00a0",quot:'"',apos:"'"},n=/^(?:https?|mailto|data)$/i,p=/^#(\d+)$/,l=/^#x([0-9A-Fa-f]+)$/,r=/\0/g,t=/&(#\d+|#x[0-9A-Fa-f]+|\w+);/g,s=/&/g,i=/&([^a-z#]|#(?:[^0-9x]|x(?:[^0-9a-f]|$)|$)|$)/gi,m=/</g,v=/>/g,w=/\"/g,x=/\=/g,y=RegExp("^\\s*(?:(?:([a-z][a-z-]*)(\\s*=\\s*(\"[^\"]*\"|'[^']*'|(?=[a-z][a-z-]*\\s*=)|[^>\"'\\s]*))?)|(/?>)|[\\s\\S][^a-z\\s>]*)","i"),z=RegExp("^(?:&(\\#[0-9]+|\\#[x][0-9a-f]+|\\w+);|<\!--[\\s\\S]*?--\>|<!\\w[^>]*>|<\\?[^>*]*>|<(/)?([a-z][a-z0-9]*)|([^<&>]+)|([<&>]))","i"),A=/^(?:([^:/?#]+):)?/;return{escapeAttrib:b,makeHtmlSanitizer:h,makeSaxParser:d,normalizeRCData:g,sanitize:function(b,d,c){var i=[];h(function(b,i){for(var h=0;h<i.length;h+=2){var f=i[h],e=i[h+1],g=null,j;if((j=b+"::"+f,a.ATTRIBS.hasOwnProperty(j))||(j="*::"+f,a.ATTRIBS.hasOwnProperty(j)))g=a.ATTRIBS[j];if(null!==g)switch(g){case a.atype.NONE:break;case a.atype.SCRIPT:case a.atype.STYLE:e=null;break;case a.atype.ID:case a.atype.IDREF:case a.atype.IDREFS:case a.atype.GLOBAL_NAME:case a.atype.LOCAL_NAME:case a.atype.CLASSES:e=c?c(e):e;break;case a.atype.URI:e=(f=(""+e).match(A))?!f[1]||n.test(f[1])?d&&d(e):null:null;break;case a.atype.URI_FRAGMENT:e&&"#"===e.charAt(0)?(e=c?c(e):e)&&(e="#"+e):e=null;break;default:e=null}else e=null;i[h+1]=e}return i})(b,i);return i.join("")},unescapeEntities:f}}(html4),html_sanitize=html.sanitize;"undefined"!==typeof window&&(window.html=html,window.html_sanitize=html_sanitize);html4.ATTRIBS["*::style"]=0;html4.ELEMENTS.style=0;html4.ATTRIBS["a::target"]=0;html4.ELEMENTS.video=0;html4.ATTRIBS["video::src"]=0;html4.ATTRIBS["video::poster"]=0;html4.ATTRIBS["video::controls"]=0;html4.ELEMENTS.audio=0;html4.ATTRIBS["audio::src"]=0;html4.ATTRIBS["video::autoplay"]=0;html4.ATTRIBS["video::controls"]=0;var wax={};wax.formatter=function(a){var c={},f;if(a&&"string"===typeof a)try{eval("f = "+a)}catch(b){console&&console.log(b)}else f=a&&"function"===typeof a?a:function(){};c.format=function(a,b){try{return wax.u.sanitize(f(a,b))}catch(c){console&&console.log(c)}};return c};wax.gi=function(a,c){var c=c||{},f={},b=c.resolution||4,g=c.tileSize||256;f.grid_tile=function(){return a};f.getKey=function(d,c){if(a&&a.grid&&!(0>c||0>d))if(!(Math.floor(c)>=g||Math.floor(d)>=g)){var e=a.grid[Math.floor(c/b)].charCodeAt(Math.floor(d/b));93<=e&&e--;35<=e&&e--;return e-32}};f.gridFeature=function(b,c){var e=this.getKey(b,c),f=a.keys;if(f&&f[e]&&a.data[f[e]])return a.data[f[e]]};f.tileFeature=function(b,c,e){if(a)return e=wax.u.offset(e),feature=this.gridFeature(b-e.left,c-e.top)};return f};wax.gm=function(){var a=4,c={},f,b,g=function(a){if(a)return a.replace(/(\.png|\.jpg|\.jpeg)(\d*)/,".grid.json")};c.formatter=function(a){if(!arguments.length)return b;b=wax.formatter(a);return c};c.template=function(a){if(!arguments.length)return b;b=wax.template(a);return c};c.gridUrl=function(a){if(!arguments.length)return g;if(a){var b;if("function"===typeof a)b=a;else{var e=a;"string"===typeof e&&(e=[e]);b=function(a){if(a&&(a=/\/(\d+)\/(\d+)\/(\d+)\.[\w\._]+/.exec(a)))return e[parseInt(a[2],10)%e.length].replace(/\{z\}/g,a[1]).replace(/\{x\}/g,a[2]).replace(/\{y\}/g,a[3])}}g=b}else g=function(){return null};return c};c.getGrid=function(d,f){var e=g(d);if(!b||!e)return f(null,null);wax.request.get(e,function(c,d){if(c)return f(c,null);f(null,wax.gi(d,{formatter:b,resolution:a}))});return c};c.tilejson=function(d){if(!arguments.length)return f;d.template?c.template(d.template):d.formatter?c.formatter(d.formatter):b=void 0;c.gridUrl(d.grids);d.resolution&&(a=d.resolution);f=d;return c};return c};wax.interaction=function(){function a(a){var e;d?(window.clearTimeout(d),d=null,e=!0):e=!1;e||(g=!0,h=wax.u.eventoffset(a),"mousedown"===a.type?(bean.add(document.body,"click",c),bean.add(document.body,"mouseup",c)):"touchstart"===a.type&&1===a.touches.length&&(bean.fire(b,"off"),bean.add(a.srcElement,s)))}function c(a){var f={},l=wax.u.eventoffset(a);g=!1;for(var j in a)f[j]=a[j];bean.remove(document.body,"mouseup",c);bean.remove(a.srcElement,s);"touchend"===a.type?b.click(a,h):Math.round(l.y/e)===Math.round(h.y/e)&&Math.round(l.x/e)===Math.round(h.x/e)&&(d=window.setTimeout(function(){d=null;b.click(f,l)},300));return c}var f=wax.gm(),b={},g=!1,d=!1,h,e=4,j,n,p,l,r,t={mousemove:function(a){if(!g){var c=wax.u.eventoffset(a);b.screen_feature(c,function(c){c?bean.fire(b,"on",{parent:l(),data:c,formatter:f.formatter().format,e:a}):bean.fire(b,"off")})}},touchstart:a,mousedown:a},s={touchend:c,touchmove:c,touchcancel:function(a){bean.remove(a.srcElement,s);g=!1}};b.click=function(a,c){b.screen_feature(c,function(c){c&&bean.fire(b,"on",{parent:l(),data:c,formatter:f.formatter().format,e:a})})};b.screen_feature=function(a,b){var c;a:{for(var d=j(),e=0;e<d.length;e++)if(d[e][0]<a.y&&d[e][0]+256>a.y&&d[e][1]<a.x&&d[e][1]+256>a.x){c=d[e][2];break a}c=!1}c||b(null);f.getGrid(c.src,function(d,e){if(d||!e)return b(null);var f=e.tileFeature(a.x,a.y,c);b(f)})};b.attach=function(a){if(!arguments.length)return n;n=a;return b};b.detach=function(a){if(!arguments.length)return p;p=a;return b};b.map=function(c){if(!arguments.length)return r;r=c;n&&n(r);bean.add(l(),t);bean.add(l(),"touchstart",a);return b};b.grid=function(a){if(!arguments.length)return j;j=a;return b};b.remove=function(){p&&p(r);bean.remove(l(),t);bean.fire(b,"remove");return b};b.tilejson=function(a){if(!arguments.length)return f.tilejson();f.tilejson(a);return b};b.formatter=function(){return f.formatter()};b.on=function(a,c){bean.add(b,a,c);return b};b.off=function(a,c){bean.remove(b,a,c);return b};b.gridmanager=function(a){if(!arguments.length)return f;f=a;return b};b.parent=function(a){l=a;return b};return b};wax.request={cache:{},locks:{},promises:{},get:function(a,c){if(this.cache[a])return c(this.cache[a][0],this.cache[a][1]);this.promises[a]=this.promises[a]||[];this.promises[a].push(c);if(!this.locks[a]){var f=this;this.locks[a]=!0;reqwest({url:a+(~a.indexOf("?")?"&":"?")+"callback=grid",type:"jsonp",jsonpCallback:"callback",success:function(b){f.locks[a]=!1;f.cache[a]=[null,b];for(b=0;b<f.promises[a].length;b++)f.promises[a][b](f.cache[a][0],f.cache[a][1])},error:function(b){f.locks[a]=!1;f.cache[a]=[b,null];for(b=0;b<f.promises[a].length;b++)f.promises[a][b](f.cache[a][0],f.cache[a][1])}})}}};wax.template=function(a){return{format:function(c,f){var b={},g;for(g in f)b[g]=f[g];c.format&&(b["__"+c.format+"__"]=!0);return wax.u.sanitize(Mustache.to_html(a,b))}}};wax.u={offset:function(a){var c=a.offsetWidth||parseInt(a.style.width,10),f=a.offsetHeight||parseInt(a.style.height,10),b=document.body,g=0,d=0,h=function(a){if(!(a===b||a===document.documentElement))if(g+=a.offsetTop,d+=a.offsetLeft,a=a.style.transform||a.style.WebkitTransform||a.style.OTransform||a.style.MozTransform||a.style.msTransform){var c;if(c=a.match(/translate\((.+)[px]?, (.+)[px]?\)/))g+=parseInt(c[2],10),d+=parseInt(c[1],10);else if(c=a.match(/translate3d\((.+)[px]?, (.+)[px]?, (.+)[px]?\)/))g+=parseInt(c[2],10),d+=parseInt(c[1],10);else if(c=a.match(/matrix3d\(([\-\d,\s]+)\)/))a=c[1].split(","),g+=parseInt(a[13],10),d+=parseInt(a[12],10);else if(c=a.match(/matrix\(.+, .+, .+, .+, (.+), (.+)\)/))g+=parseInt(c[2],10),d+=parseInt(c[1],10)}};if("undefined"!==typeof a.getBoundingClientRect)var e=document.body,j=a.ownerDocument.documentElement,h=document.clientTop||e.clientTop||0,e=document.clientLeft||e.clientLeft||0,n=window.pageYOffset||j.scrollTop,j=window.pageXOffset||j.scrollLeft,a=a.getBoundingClientRect(),g=a.top+n-h,d=a.left+j-e;else{h(a);try{for(;a=a.offsetParent;)h(a)}catch(p){}}g+=b.offsetTop;d+=b.offsetLeft;g+=b.parentNode.offsetTop;d+=b.parentNode.offsetLeft;a=document.defaultView?window.getComputedStyle(b.parentNode,null):b.parentNode.currentStyle;b.parentNode.offsetTop!==parseInt(a.marginTop,10)&&!isNaN(parseInt(a.marginTop,10))&&(g+=parseInt(a.marginTop,10),d+=parseInt(a.marginLeft,10));return{top:g,left:d,height:f,width:c}},$:function(a){return"string"===typeof a?document.getElementById(a):a},eventoffset:function(a){a||(a=window.event);if(a.pageX||a.pageY)return{x:a.pageX,y:a.pageY};if(a.clientX||a.clientY)return{x:a.clientX,y:a.clientY};if(a.touches&&1===a.touches.length)return{x:a.touches[0].pageX,y:a.touches[0].pageY}},limit:function(a,c,f){var b;return function(){var g=this,d=arguments,h=function(){b=null;a.apply(g,d)};f&&clearTimeout(b);if(f||!b)b=setTimeout(h,c)}},throttle:function(a,c){return this.limit(a,c,!1)},sanitize:function(a){return!a?"":html_sanitize(a,function(a){if(/^(https?:\/\/|data:image)/.test(a))return a},function(a){return a})}};

define([
  'Event',
  'InfoBox',
  'Util/Util'
], function(Event, InfoBox, Util) {
  var
      // The active notification messages.
      activeNotificationMessages = [],
      // The combined pixel height of all the active notification messages.
      activeNotificationMessagesHeight = 0,
      // The map div.
      divMap = document.getElementById(NPMap.config.div),
      // The modules div.
      divModules,
      // The modules close div.
      divModulesClose,
      // The module tabs div.
      divModuleTabs,
      // The notify div.
      divNotify,
      // The npmap div.
      divNpmap = document.getElementById('npmap'),
      // The npmap-controls div.
      divNpmapControls = document.getElementById('npmap-map-controls'),
      // The parent div.
      divNpmapParent = document.getElementById('npmap').parentNode,
      // The npmap-progressbar div.
      divProgressBar,
      // The tip div.
      divTip,
      // Does the map have active tile layers?
      hasTiled = false,
      // Is the map in fullscreen mode?
      isFullScreen = false,
      //
      mouseDownPixel = null,
      // The id of the active mousemove handler.
      mouseMoveId,
      // The zoombox.
      zoombox = document.createElement('div'),
      // General scales for zoom levels, in meters.
      zoomScales = [
        295829355,
        147914668,
        73957339,
        36978669,
        18489335,
        9244667,
        4622334,
        2311166,
        1155583,
        577792,
        288896,
        144448,
        72224,
        36112,
        18056,
        9028,
        4514,
        2257,
        1128,
        564
      ];

  /**
   * Creates a notify div.
   * @param {String} message
   * @param {String} title (Optional)
   * @param {String} type (Optional)
   * @return {Object}
   */
  function createNotify(message, title, type) {
    var cls = 'content',
        html = '';
        msg = document.createElement('div');

    if (type) {
      cls += ' ' + type;
    }

    msg.className = cls;

    if (title) {
      html += '<h3>' + title + '</h3><p>' + message + '</p>';
    } else {
      html += '<p style="text-align:center;">' + message + '</p>';
    }

    msg.innerHTML = html;

    return msg;
  }
  /**
   * Gets the pixel coordinates of a mouse click event.
   * @param {Object} e
   * @return {Object}
   */
  function getMousePixel(e) {
    var pixel = {
          x: e.clientX,
          y: e.clientY
        },
        position = Util.getOffset(divMap),
        scroll = Util.getScrollPosition(divMap);

    pixel.x = pixel.x - position.left + scroll.left;
    pixel.y = pixel.y - position.top + scroll.top;

    return pixel;
  }
  /**
   * Hooks up the click event to an element.
   * @param {String} id
   * @param {Function} func
   * @return {Object}
   */
  function hookUpClickEvent(id, func) {
    var el = document.getElementById(id);
    
    Util.stopAllPropagation(el);
    bean.add(el, 'mouseup', function(e) {
      func();
    });

    return el;
  }
  /**
   * Handles the mousemove event for the npmap-zoombox control.
   * @param {Object} e
   * @return null
   */
  function mouseMoveZoomBox(e) {
    var left,
        pixel = getMousePixel(e),
        top;

    zoombox.style.display = 'block';

    if (pixel.x < mouseDownPixel.x) {
      left = pixel.x;
    } else {
      left = mouseDownPixel.x;
    }

    zoombox.style.left = left + 'px';
    zoombox.style.width = Math.abs(pixel.x - mouseDownPixel.x) + 'px';

    if (pixel.y < mouseDownPixel.y) {
      top = pixel.y;
    } else {
      top = mouseDownPixel.y;
    }

    zoombox.style.height = Math.abs(pixel.y - mouseDownPixel.y) + 'px';
    zoombox.style.top = top + 'px';
  }
  /**
   * Sets the width of the attribution control based on the width of the map and logos and positions it.
   * @return null
   */
  function setAttributionMaxWidthAndPosition() {
    var divAttribution = document.getElementById('npmap-attribution'),
        divOverviewMap = document.getElementById('npmap-overviewmap'),
        max = Util.getOuterDimensions(divMap).width - Util.getOuterDimensions(document.getElementById('npmap-logos')).width - 40,
        right = 0;

    if (divOverviewMap) {
      var divOverviewMapWidth = Util.getOuterDimensions(divOverviewMap).width;

      max = max - divOverviewMapWidth;
      right = divOverviewMapWidth;
    }
    
    if (max > 0) {
      divAttribution.style.maxWidth = max + 'px';
    }
    
    divAttribution.style.right = right + 'px';
  }

  /**
   * @class NPMap.Map
   *
   * The base class for all map objects. No "baseApi" specific code lives here.
   */
  return NPMap.Map = {
    // An array of event handler objects that have been added to this class.
    _events: [{
      event: 'mousedown',
      func: function(e) {
        mouseDownPixel = getMousePixel(e);

        if (e.shiftKey) {
          zoombox.style.display = 'block';
          zoombox.style.left = mouseDownPixel.x + 'px';
          zoombox.style.top = mouseDownPixel.y + 'px';
          mouseMoveId = NPMap.Event.add('NPMap.Map', 'mousemove', mouseMoveZoomBox);
          
          NPMap.Map.setCursor('crosshair');
        }
      }
    },{
      event: 'mouseup',
      func: function(e) {
        if (e.shiftKey) {
          var pixel = getMousePixel(e),
              coords = {},
              nw,
              se;
              
          if (pixel.x > mouseDownPixel.x) {
            coords.e = pixel.x;
            coords.w = mouseDownPixel.x;
          } else {
            coords.e = mouseDownPixel.x;
            coords.w = pixel.x;
          }

          if (pixel.y > mouseDownPixel.y) {
            coords.n = pixel.y;
            coords.s = mouseDownPixel.y;
          } else {
            coords.n = mouseDownPixel.y;
            coords.s = pixel.y;
          }

          nw = NPMap.Map.pixelToLatLng({
            x: coords.w,
            y: coords.n
          });
          se = NPMap.Map.pixelToLatLng({
            x: coords.e,
            y: coords.s
          });

          NPMap.Map.toBounds({
            e: se.lng,
            n: nw.lat,
            s: se.lat,
            w: nw.lng
          });
          NPMap.Map.setCursor('auto');

          mouseDownPixel = null;
          zoombox.style.display = 'none';
          zoombox.style.height = '0px';
          zoombox.style.width = '0px';

          NPMap.Event.remove(mouseMoveId);
        }
      }
    },{
      event: 'zoomstart',
      func: function() {
        if (!NPMap.InfoBox.marker) {
          NPMap.InfoBox.hide();
        }
      }
    }],
    /**
     * Creates a line using the baseApi's line class, if it exists.
     * @param {Array} latLngs An array of the latitude/longitude strings, in "latitude,longitude" format, to use to create the line.
     * @param {Object} options (Optional) Line options.
     */
    _createLine: function(latLngs, options) {
      var apiLatLngs = [],
          me = this;
      
      _.each(latLngs, function(latLng) {
        apiLatLngs.push(me.latLngToApi(latLng));
      });
      
      return NPMap.Map[NPMap.config.api].createLine(apiLatLngs, options);
    },
    /**
     * Creates a marker using the baseApi's marker class, if it exists.
     * @param {String} latLng The latitude/longitude string, in "latitude,longitude" format, to use to create the marker.
     * @param {Object} options (Optional) Marker options.
     */
    _createMarker: function(latLng, options) {
      return NPMap.Map[NPMap.config.api].createMarker(this.latLngToApi(latLng), options);
    },
    /**
     * Creates a polygon using the baseApi's marker class, if it exists.
     * @param {Array} latLngs An array of latitude/longitude strings, in "latitude,longitude" format, to use to create the polygon.
     * @param {Object} options (Optional) Polygon options.
     * @return {Object}
     */
    _createPolygon: function(latLngs, options) {
      var apiLatLngs = [],
          me = this;

      for (var i = 0; i < latLngs.length; i++) {
        apiLatLngs.push(me.latLngToApi(latLngs[i]));
      }

      return NPMap.Map[NPMap.config.api].createPolygon(apiLatLngs, options);
    },
    /**
     * Initializes the construction of the NPMap.Map class. This is called by the baseApi map object after its map is created and should never be called manually.
     */
    _init: function() {
      var me = this;

      Util.safeLoad('NPMap.Map.' + NPMap.config.api, function() {
        var
            // The attribution control div.
            attribution = document.createElement('div'),
            // The "clickdot" div.
            clickdot = document.createElement('div'),
            // An array of elements to add to the map div.
            elements = [],
            // HTML for the logos div.
            logosHtml = '',
            // The config object for NPMap's modules.
            modulesConfig = NPMap.config.modules || null,
            // The notify div.
            notify = document.createElement('div'),
            // The progress div.
            progress = document.createElement('div'),
            // The tip div.
            tip = document.createElement('div'),
            // The config object for NPMap's tools. Supports legacy config information too.
            toolsConfig = (function() {
              if (NPMap.config.tools) {
                return {
                  fullscreen: NPMap.config.tools.fullscreen || false,
                  navigation: NPMap.config.tools.navigation || {
                    pan: NPMap.config.tools.pan || 'home',
                    position: 'top left',
                    zoom: NPMap.config.tools.zoom || 'small'
                  },
                  overview: NPMap.config.tools.overview || false,
                  print: NPMap.config.tools.print || false,
                  share: NPMap.config.tools.share || false
                };
              } else if (typeof NPMap.config.tools === 'undefined') {
                return {
                  fullscreen: false,
                  navigation: {
                    pan: 'home',
                    position: 'top left',
                    zoom: 'small'
                  },
                  overview: false,
                  print: false,
                  share: false
                };
              } else {
                return {};
              }
            })();

        function hookUpNavigationControl(id, handler) {
          var el = document.getElementById(id);

          bean.add(el, 'click dblclick mousedown', function(e) {
            e.stop();
          });
          bean.add(el, 'mouseup', function(e) {
            e.stop();
            handler();
          });
          
          return el;
        }

        attribution.id = 'npmap-attribution';
        elements.push({
          el: attribution,
          func: function() {
            setAttributionMaxWidthAndPosition();
          }
        });
        clickdot.id = 'npmap-clickdot';
        elements.push({
          el: clickdot
        });
        notify.id = 'npmap-notify';
        elements.push({
          el: notify
        });
        progress.id = 'npmap-progressbar';
        progress.innerHTML = '<div></div>';
        elements.push({
          el: progress
        });
        tip.className = 'padded rounded shadowed transparent';
        tip.id = 'npmap-tip';
        elements.push({
          el: tip
        });
        zoombox.id = 'npmap-zoombox';
        elements.push({
          el: zoombox,
          stop: false
        });
        
        if (NPMap.config.api.toLowerCase() !== 'leaflet' && NPMap.config.api.toLowerCase() !== 'modestmaps') {
          logosHtml += '<span style="display:block;float:left;margin-right:8px;"><img src="' + NPMap.config.server + '/resources/img/' + NPMap.config.api.toLowerCase() + 'logo.png" /></span>';
        }
        
        if (!NPMap.config.hideNpmapLogo) {
          logosHtml += '<span style="display:block;float:left;"><a href="http://www.nps.gov/npmap" target="_blank"><img src="' + NPMap.config.server + '/resources/img/npmaplogo.png" alt="NPMap - Web Mapping for the U.S. National Park Service" /></a></span>';
        }

        if (logosHtml.length > 0) {
          // The logo div.
          var logos = document.createElement('div');
          
          logos.id = 'npmap-logos';
          logos.innerHTML = logosHtml;
          logos.style.cssText = 'bottom:3px;height:30px;left:5px;position:absolute;z-index:30;';
          elements.push({
            el: logos,
            func: function() {
              Util.monitorResize(document.getElementById('npmap-logos'), function() {
                setAttributionMaxWidthAndPosition();
              });
              setAttributionMaxWidthAndPosition();
            }
          });
        }

        if (toolsConfig.navigation) {
          var
              // An array of callback functions.
              callbacksNavigation = [],
              // The navigation controls div.
              navigation = document.createElement('div'),
              // HTML string for the navigation div.
              navigationHtml = '',
              // The position string for the navigation tools.
              position = toolsConfig.navigation.position.split(' ');
              
          if (toolsConfig.navigation.pan) {
            var compass = toolsConfig.navigation.pan;

            navigation.style.width = '58px';

            navigationHtml += '<div id="npmap-navigation-compass" class="npmap-navigation-compass-' + compass + '"><a id="npmap-navigation-compass-east" class="pointer"></a><a id="npmap-navigation-compass-north" class="pointer"></a><a id="npmap-navigation-compass-south" class="pointer"></a><a id="npmap-navigation-compass-west" class="pointer"></a>';
            
            if (compass === 'home') {
              navigationHtml += '<a id="npmap-navigation-compass-center" class="pointer"></a>';
            }
            
            navigationHtml += '</div>';

            callbacksNavigation.push(function() {
              var buttons = [];

              buttons.push(hookUpNavigationControl('npmap-navigation-compass-east', function() {
                NPMap.Map.panInDirection('east');
              }));
              buttons.push(hookUpNavigationControl('npmap-navigation-compass-north', function() {
                NPMap.Map.panInDirection('north');
              }));
              buttons.push(hookUpNavigationControl('npmap-navigation-compass-south', function() {
                NPMap.Map.panInDirection('south');
              }));
              buttons.push(hookUpNavigationControl('npmap-navigation-compass-west', function() {
                NPMap.Map.panInDirection('west');
              }));
              
              if (compass === 'home') {
                hookUpNavigationControl('npmap-navigation-compass-center', function() {
                  me.toInitialExtent();
                });
              }
              
              for (var i = 0; i < buttons.length; i++) {
                var button = buttons[i],
                    compassEl = document.getElementById('npmap-navigation-compass');
                    
                button.direction = button.id.split('-')[3];
                
                bean.add(button, 'mouseenter', function(e) {
                  compassEl.className = compassEl.className.replace('npmap-navigation-compass-' + compass, ' npmap-navigation-compass-' + compass + '-' + this.direction + '-over');
                });
                bean.add(button, 'mouseleave', function(e) {
                  compassEl.className = compassEl.className.replace(' npmap-navigation-compass-' + compass + '-' + this.direction + '-over', 'npmap-navigation-compass-' + compass);
                });
              }
            });
          }
          
          if (toolsConfig.navigation.zoom === 'small') {
            navigationHtml += '<div id="npmap-navigation-small-zoom" class="npmap-navigation-small-zoom"';
            
            if (typeof toolsConfig.navigation.pan !== 'undefined') {
              navigationHtml += ' style="margin-left:17px;margin-top:5px;"';
            }
            
            navigationHtml += '><a id="npmap-navigation-small-zoom-in" class="pointer"></a><a id="npmap-navigation-small-zoom-out" class="pointer"></a></div>';

            callbacksNavigation.push(function() {
              var buttons = [];
            
              buttons.push(hookUpNavigationControl('npmap-navigation-small-zoom-in', function() {
                NPMap.Map.zoomIn();
              }));
              buttons.push(hookUpNavigationControl('npmap-navigation-small-zoom-out', function() {
                NPMap.Map.zoomOut();
              }));
              
              for (var i = 0; i < buttons.length; i++) {
                var button = buttons[i],
                    divZoom = document.getElementById('npmap-navigation-small-zoom'); 
                
                button.inOrOut = button.id.split('-')[4];
                
                bean.add(button, 'mouseenter', function(e) {
                  divZoom.className += '-' + this.inOrOut + '-over';
                });
                bean.add(button, 'mouseleave', function(e) {
                  divZoom.className = divZoom.className.replace('-' + this.inOrOut + '-over', '');
                });
              }
            });
          }

          if (position[0] === 'bottom') {
            navigation.style.bottom = '15px';
          } else {
            navigation.style.top = '15px';
          }
          
          if (position[1]) {
            if (position[1] === 'left') {
              navigation.style.left = '15px';
            } else {
              navigation.style.right = '15px';
            }
          } else {
            navigation.style.left = '15px';
          }

          navigation.id = 'npmap-navigation';
          navigation.innerHTML = navigationHtml;
          navigation.style.position = 'absolute';
          navigation.style.zIndex = '30';
          elements.push({
            el: navigation,
            func: function() {
              for (var i = 0; i < callbacksNavigation.length; i++) {
                callbacksNavigation[i]();
              }
            }
          });
        }
        
        if (toolsConfig.fullscreen || toolsConfig.print || toolsConfig.share) {
          var callbacks = [],
              html = '<ul id="npmap-tools">',
              toolbar = document.createElement('div');

          if (toolsConfig.fullscreen) {
            html += '<li id="npmap-toolbar-fullscreen"><div class="npmap-toolbar-fullscreen"></div></li>';

            callbacks.push(function() {
              hookUpClickEvent('npmap-toolbar-fullscreen', function() {
                NPMap.Map.toggleFullScreen();
              });
            });
          }

          if (toolsConfig.print) {
            html += '<li id="npmap-toolbar-print"><div class="npmap-toolbar-print"></div></li>';
            //callbacks.push();
          }

          if (toolsConfig.share) {
            html += '<li id="npmap-toolbar-share"><div class="npmap-toolbar-share"></div></li>';
            //callbacks.push();
          }

          toolbar.innerHTML = html + '</ul>';
          toolbar.id = 'npmap-toolbar';
          
          divMap.style.top = '28px';

          divNpmap.insertBefore(toolbar, divMap);

          for (var i = 0; i < callbacks.length; i++) {
            callbacks[i]();
          }

          callbacks = [];
        }

        if (NPMap.config.modules && NPMap.config.modules.length > 0) {
          /**
                Support two use cases: 1) modules built into the library, 2) custom modules included in NPMap.config.

                1) Modules built into the library

                - Match the "name" property up, and use the built-in module
                - Configuration should be done via the NPMap.config.modules['ModuleName'] object
                - Icon and content should be 

                2) Custom modules included in NPMap.config

                - If the "name" property doesn't match up to a built-in module, it is a custom module
                - If "html" property isn't specified, it isn't valid so skip it
                - If icon isn't specified, use a generic icon

                Available config properties:

                - expanded {Boolean} Defaults to false
           */

          var build = [];

          for (var i = 0; i < NPMap.config.modules.length; i++) {
            var module = NPMap.config.modules[i],
                name = module.name;

            if (name) {
              var id = name.toLowerCase();

              module.id = id.split(' ').join('_');

              if (typeof module.html === 'string' && id !== 'edit' && id !== 'route') {
                build.push(module);
              }
            }
          }

          if (build.length) {
            var htmlModules = '',
                htmlTabs = '';

            divModules = document.createElement('div');
            divModulesClose = document.createElement('div');
            divModuleTabs = document.createElement('div');

            for (var i = 0; i < build.length; i++) {
              var module = NPMap.config.modules[i],
                  id = module.id;

              htmlModules += '<div id="npmap-modules-' + id + '" class="npmap-module">' + module.html + '</div>';
              htmlTabs += '<div id="npmap-module-tab-' + id + '" class="npmap-module-tab" onclick="NPMap.Map.openModule(this);return false;">';

              if (typeof module.icon === 'string') {
                htmlTabs += '<div class="npmap-module-tab-' + module.icon + '"></div>';
              } else {
                // TODO: Need to replace with a generic tab icon.
                htmlTabs += '<div class="npmap-module-tab-route"></div>';
              }

              htmlTabs += '</div>';
            }

            divModules.id = 'npmap-modules';
            divModules.innerHTML = htmlModules;
            divModulesClose.className = 'npmap-module-tab';
            divModulesClose.id = 'npmap-modules-close';
            divModulesClose.innerHTML = '<div class="npmap-module-tab-close" style="margin-left:-1px;margin-top:' + (document.getElementById('npmap-toolbar') ? '45px' : '15px') + ';"></div>';
            divModuleTabs.id = 'npmap-modules-tabs';
            divModuleTabs.innerHTML = htmlTabs;

            elements.push({
              el: divModuleTabs
            });
            divNpmap.insertBefore(divModules, divMap);
            divNpmap.insertBefore(divModulesClose, divMap);
            bean.add(document.getElementById('npmap-modules-close'), 'click', function() {
              NPMap.Map.closeModules();
            });

            for (var i = 0; i < divModules.childNodes.length; i++) {
              bean.add(divModules.childNodes[i], 'mousewheel', function(e) {
                if ((this.scrollTop === 0 && e.wheelDeltaY > 0) || ((this.scrollTop === (this.scrollHeight - this.offsetHeight)) && e.wheelDeltaY < 0)) {
                  Util.eventCancelMouseWheel(e);
                }
              });
            }
          }
        }

        // TODO: This is currently Bing specific.
        if ((toolsConfig.overviewMap || toolsConfig.overview) && NPMap.config.api === 'bing') {
          var divOverview = document.createElement('div');

          divOverview.id = 'npmap-overview';
          divOverview.innerHTML = '<div id="npmap-overview-title" style="color:#454545;display:none;padding:8px;position:absolute;">Overview Map</div><div id="npmap-overview-map" style="bottom:0px;left:0px;position:absolute;right:0px;top:0px;"></div>';
          divOverview.style.bottom = Util.getOuterDimensions(document.getElementById('npmap-attribution')).height + 'px';
          
          elements.push({
            el: divOverview,
            func: function() {
              var divOverviewButton = document.createElement('div'),
                  divOverviewMap = document.getElementById('npmap-overview-map'),
                  divOverviewTitle = document.getElementById('npmap-overview-title'),
                  mapOverview = new Microsoft.Maps.Map(divOverviewMap, {
                    credentials: NPMap.config.credentials ? NPMap.config.credentials : 'AqZQwVLETcXEgQET2dUEQIFcN0kDsUrbY8sRKXQE6dTkhCDw9v8H_CY8XRfZddZm',
                    disablePanning: true,
                    disableZooming: true,
                    fixedMapPosition: true,
                    mapTypeId: Microsoft.Maps.MapTypeId.road,
                    showBreadcrumb: false,
                    showCopyright: false,
                    showDashboard: false,
                    showLogo: false,
                    showMapTypeSelector: false,
                    showScalebar: false
                  });

              function updateOverviewMap() {
                var bounds = NPMap.bing.map.Map.getBounds(),
                    nw = bounds.getNorthwest(),
                    se = bounds.getSoutheast(),
                    ne = new Microsoft.Maps.Location(se.latitude, nw.longitude),
                    sw = new Microsoft.Maps.Location(nw.latitude, se.longitude);
                
                mapOverview.setView({
                  bounds: bounds,
                  padding: 20
                });
                mapOverview.entities.clear();

                if (Util.hasClass(divOverviewButton, 'expanded')) {
                  mapOverview.entities.push(new Microsoft.Maps.Polygon([
                    nw,
                    ne,
                    se,
                    sw,
                    nw
                  ], {
                    fillColor: new Microsoft.Maps.Color(175, 218, 233, 228),
                    strokeColor: new Microsoft.Maps.Color(255, 186, 197, 191),
                    strokeThickness: 1
                  }));
                }
              }

              Util.stopAllPropagation(divOverview);

              divOverviewButton.id = 'npmap-overviewmap-button';
              divOverviewButton.className = 'npmap-overview-open cursor';
              divOverviewButton.style.cssText = 'position:absolute;';

              document.getElementById('npmap-overview-map').appendChild(divOverviewButton);

              bean.add(divOverviewButton, 'click', function() {
                if (Util.hasClass(this, 'expanded')) {
                  this.style.display = 'none';
                  divOverviewMap.style.top = '0px';
                  // TODO: Animate this resize.
                  divOverview.style.height = '48px';
                  divOverview.style.width = '48px';
                  
                  mapOverview.setOptions({
                    height: 48,
                    width: 48
                  });
                  setAttributionMaxWidthAndPosition();
                  updateOverviewMap();
                  Util.removeClass(this, 'npmap-overview-close-over');
                  Util.removeClass(this, 'expanded');
                  Util.addClass(this, 'npmap-overview-open');
                  mapOverview.entities.clear();
                } else {
                  divOverviewTitle.style.display = 'block';
                  divOverviewMap.style.top = Util.getOuterDimensions(divOverviewTitle).height + 'px';
                  // TODO: Animate this resize.
                  divOverview.style.height = '173px';
                  divOverview.style.width = '174px';

                  mapOverview.setOptions({
                    height: 173,
                    width: 174
                  });
                  setAttributionMaxWidthAndPosition();
                  updateOverviewMap();
                  Util.removeClass(this, 'npmap-overview-open');
                  Util.removeClass(this, 'npmap-overview-open-over');
                  Util.addClass(this, 'npmap-overview-close');
                  Util.addClass(this, 'expanded');
                }
              });
              bean.add(divOverviewButton, 'mouseover', function() {
                if (Util.hasClass(this, 'expanded')) {
                  Util.removeClass(this, 'npmap-overview-close');
                  Util.addClass(this, 'npmap-overview-close-over');
                } else {
                  Util.removeClass(this, 'npmap-overview-open');
                  Util.addClass('npmap-overview-open-over');
                }
              });
              bean.add(divOverviewButton, 'mouseout', function() {
                if (Util.hasClass(this, 'expanded')) {
                  Util.removeClass(this, 'npmap-overview-close-over');
                  Util.addClass(this, 'npmap-overview-close');
                } else {
                  Util.removeClass(this, 'npmap-overview-open-over');
                  Util.addClass(this, 'npmap-overview-open');
                }
              });
              
              /*
              Microsoft.Maps.Events.addHandler(overviewMap, 'viewchangeend', function() {
                NPMap.bing.map.Map.setView({
                  center: overviewMap.getCenter()
                });
              });
              */
              
              Event.add('NPMap.Map', 'viewchanged', function(e) {
                updateOverviewMap();
              });
            }
          });
        }

        if (NPMap.config.baseLayers && NPMap.config.baseLayers.length > 1) {
          var activeIcon = null,
              activeLabel = null,
              items = [];

          _.each(NPMap.config.baseLayers, function(baseLayer) {
            var type = baseLayer.type.toLowerCase();

            if (type === 'aerial' || type === 'blank' || type === 'hybrid' || type === 'streets' || type === 'terrain') {
              baseLayer = NPMap.Map[NPMap.config.api].getBaseLayer(baseLayer);

              if (baseLayer) {
                if (baseLayer.icon.length > 0) {
                  baseLayer.icon = NPMap.config.server + '/resources/img/tools/switcher/' + baseLayer.icon + '-small.png';
                } else {
                  baseLayer.icon = NPMap.config.server + '/resources/img/tools/switcher/blank-small.png';
                }

                if (!activeIcon && (typeof baseLayer.visible === 'undefined' || baseLayer.visible === true)) {
                  activeIcon = baseLayer.icon;
                  activeLabel = baseLayer.name;
                }
                
                items.push(baseLayer);
              }
            }
          });

          if (items.length) {
            var divSwitcher = document.createElement('div'),
                divSwitcherMenu = document.createElement('div');
            
            function setIcon(url) {
              document.getElementById('npmap-switcher-dropdown-icon').innerHTML = '<img src="' + url + '" style="height:15px;margin-top:4.5px;" />';
            }
            function setLabel(text) {
              document.getElementById('npmap-switcher-dropdown-text').innerHTML = text.toUpperCase();
            }

            items.sort(function(a, b) {
              return a.name > b.name;
            });

            divSwitcher.className = 'npmap-switcher-dropdown';
            divSwitcher.id = 'npmap-switcher';
            divSwitcher.innerHTML = '<div id="npmap-switcher-dropdown-left"></div><div id="npmap-switcher-dropdown-icon"></div><div id="npmap-switcher-dropdown-text"></div><div id="npmap-switcher-dropdown-right"></div>';
            divSwitcherMenu.id = 'npmap-switcher-menu';
            divSwitcherMenu.style.cssText = 'display:none;position:absolute;right:16px;top:38px;';
            
            elements.push({
              el: divSwitcher
            }, {
              el: divSwitcherMenu,
              func: function() {
                var htmlMenu = '<ul>';

                if (activeIcon.length > 0) {
                  setIcon(activeIcon);
                }

                if (activeLabel.length > 0) {
                  setLabel(activeLabel);
                }

                _.each(items, function(item, i) {
                  htmlMenu += '<li class="npmap-switcher-menu-item" style="list-style-type:none;"><a href="javascript:void(0)"><div style="color:#818177;height:28px;line-height:28px;vertical-align:middle;"><div style="float:left;text-align:center;width:35px;"><img src="' + item.icon.replace('small', 'large') + '" style="height:22px;margin-top:3px;"></div><div style="float:right;margin-left:5px;width:100px;">' + item.name + '</div></div></a></li>';
                });
                bean.add(divSwitcher, 'click', function(e) {
                  var display = divSwitcherMenu.style.display;

                  if (display === '' || display === 'none') {
                    divSwitcherMenu.style.display = 'block';
                  } else {
                    divSwitcherMenu.style.display = 'none';
                  }
                });

                divSwitcherMenu.innerHTML = htmlMenu + '</ul>';

                _.each(Util.getElementsByClass('npmap-switcher-menu-item'), function(el, i) {
                  bean.add(el, 'click', function(e) {
                    var clicked,
                        me = this;

                    for (var i = 0; i < items.length; i++) {
                      var item = items[i];

                      if (item.name === me.firstChild.firstChild.childNodes[1].innerHTML) {
                        setIcon(item.icon.replace('large', 'small'));
                        setLabel(item.name);
                        NPMap.Map[NPMap.config.api].switchBaseLayer(item);
                        divSwitcherMenu.style.display = 'none';
                      }
                    }
                  });
                });
              }
            });
          }
        }

        for (var i = 0; i < elements.length; i++) {
          var element = elements[i];

          me.addControl(element.el, element.func, element.stop);
        }

        var interval = setInterval(function() {
          if (NPMap.Map[NPMap.config.api] && NPMap.Map[NPMap.config.api]._isReady === true) {
            var hasType = false;

            // TODO: Iterate through all child elements of #npmap-map and detect width and set InfoBox padding. Right now this is hardcoded in NPMap.Infobox module.

            clearInterval(interval);

            /*
            NPMap.Util.safeLoad('NPMap.Layer', function() {
              me.setAttribution(me.buildAttributionString());
            });
            */

            /*
            for (var i = 0; i < NPMap.config.baseLayers.length; i++) {
              var baseLayer = NPMap.config.baseLayers[i];

              if (baseLayer.type) {
              
              }
            }
            */

            Util.monitorResize(divMap, function() {
              setAttributionMaxWidthAndPosition();
              me.handleResize();
              Event.trigger('NPMap.Map', 'resized');
            });
            Event.trigger('NPMap.Map', 'ready');
          }
        }, 0);
      });
    },
    /**
     * Adds an HTML element to the npmap-controls div.
     * @param {Object} el
     * @param {Function} callback (Optional)
     * @param {Boolean} stopPropagation (Optional)
     * @return null
     */
    addControl: function(el, callback, stopPropagation) {
      var div = NPMap.Map[NPMap.config.api].getMapElement();
      
      if (el.style.zIndex === '' && el.style.cssText.indexOf('z-index') === -1) {
        el.style.zIndex = '1';
      }

      div.appendChild(el);
      
      if (typeof stopPropagation === 'undefined' || stopPropagation === true) {
        Util.stopAllPropagation(el);
      }

      if (callback) {
        callback();
      }
    },
    /**
     * Adds a shape to the map.
     * @param {Object} shape The shape to add to the map. This can be a base API marker, line, or polygon object.
     * @return null
     */
    addShape: function(shape) {
      NPMap.Map[NPMap.config.api].addShape(shape);
    },
    /**
     * Adds a tile layer to the map.
     * @param {Object} layer The layer to add to the map. This object should be created with the base API.
     * @return null
     */
    addTileLayer: function(layer) {
      NPMap.Map[NPMap.config.api].addTileLayer(layer);
    },
    /**
     * Adds a Zoomify layer to the map.
     * @param {Object} layer The layer to add to the map. This object should be created with the base API.
     * @return null
     */
    addZoomifyLayer: function(layer) {
      NPMap.Map[NPMap.config.api].addZoomifyLayer(layer);
    },
    /**
     * Converts an API bounds to a NPMap bounds.
     * @param {Object} bounds
     * @return {Object}
     */
    boundsFromApi: function(bounds) {
      return NPMap.Map[NPMap.config.api].boundsFromApi(bounds);
    },
    /**
     * Converts a NPMap bounds to an API bounds.
     * @param {Object} bounds
     * @return {Object}
     */
    boundsToApi: function(bounds) {
      return NPMap.Map[NPMap.config.api].boundsToApi(bounds);
    },
    /**
     * Centers the map.
     * @param {Object} latLng The latLng object to center the map on.
     * @return null
     */
    center: function(latLng) {
      NPMap.Map[NPMap.config.api].center(NPMap.Map[NPMap.config.api].latLngToApi(latLng));
    },
    /**
     * Centers then zooms the map.
     * @param {Object} latLng The latLng object to center the map on.
     * @param {Number} zoom The zoom level to zoom the map to.
     * @param {Function} callback (Optional) A callback function to call after the map has been centered and zoomed.
     * @return null
     */
    centerAndZoom: function(latLng, zoom, callback) {
      NPMap.Map[NPMap.config.api].centerAndZoom(NPMap.Map[NPMap.config.api].latLngToApi(latLng), zoom, callback);
    },
    /**
     * Closes the modules panel.
     * @return null
     */
    closeModules: function() {
      divModulesClose.style.display = 'none';
      divModules.style.display = 'none';
      divModuleTabs.style.display = 'block';
      divMap.style.left = '0';
    },
    /**
     * Creates a line using the base API's line class.
     * @param {Array} latLngs An array of the latitude/longitude objects to use to create the line.
     * @param {Object} options (Optional) Line options.
     * @return {Object}
     */
    createLine: function(latLngs, options) {
      options = options || {};

      return this._createLine(latLngs, NPMap.Map[NPMap.config.api].convertLineOptions(options));
    },
    /**
     * Creates a marker using the base API's marker class.
     * @param {String} latLng The latitude/longitude object to use to create the marker.
     * @param {Object} options (Optional) Marker options.
     * @return {Object}
     */
    createMarker: function(latLng, options) {
      options = options || {};

      return this._createMarker(latLng, NPMap.Map[NPMap.config.api].convertMarkerOptions(options));
    },
    /**
     * Creates a polygon using the base API's polygon class.
     * @param {Array} latLngs An array of latitude/longitude objects to use to create the polygon.
     * @param {Object} options (Optional) Polygon options.
     * @return {Object}
     */
    createPolygon: function(latLngs, options) {
      options = options || {};

      return this._createPolygon(latLngs, NPMap.Map[NPMap.config.api].convertPolygonOptions(options));
    },
    /**
     * Creates a Zoomify layer.
     * @param {Object} config
     * @return {Object}
     */
    createZoomifyLayer: function(config) {
      return NPMap.Map[NPMap.config.api].createZoomifyLayer(config);
    },
    /**
     * Gets the map bounds.
     * @return {Object}
     */
    getBounds: function() {
      return this.boundsFromApi(NPMap.Map[NPMap.config.api].getBounds());
    },
    /**
     * Gets the center of the map.
     * @return {Object}
     */
    getCenter: function() {
      return this.latLngFromApi(NPMap.Map[NPMap.config.api].getCenter());
    },
    /**
     * Gets the map element.
     * @return {Object}
     */
    getMapElement: function() {
      return NPMap.Map[NPMap.config.api].getMapElement();
    },
    /**
     * Get the marker latitude and longitude.
     * @param {Object} marker
     * @return {Object}
     */
    getMarkerLatLng: function(marker) {
      return this.latLngFromApi(NPMap.Map[NPMap.config.api].getMarkerLatLng(marker));
    },
    /**
     * Gets a marker option.
     * @param {Object} marker The marker object.
     * @param {String} option The option to get. Currently the valid options are: 'icon'.
     * @return {String}
     */
    getMarkerOption: function(marker, option) {
      return NPMap.Map[NPMap.config.api].getMarkerOption(marker, option);
    },
    /**
     * Gets the visibility property of a marker.
     * @param {Object} marker The marker to check the visibility for.
     * @return {Boolean}
     */
    getMarkerVisibility: function(marker) {
      return NPMap.Map[NPMap.config.api].getMarkerVisibility(marker);
    },
    /**
     * Gets the maximum zoom level for the map.
     * @return {Number}
     */
    getMaxZoom: function() {
      return NPMap.Map[NPMap.config.api].getMaxZoom();
    },
    /**
     * Gets the minimum zoom level for the map.
     * @return {Number}
     */
    getMinZoom: function() {
      return NPMap.Map[NPMap.config.api].getMinZoom();
    },
    /**
     * Gets the zoom level of the map.
     * @return {Number}
     */
    getZoom: function() {
      return NPMap.Map[NPMap.config.api].getZoom();
    },
    /**
     * Handles any necessary sizing and positioning for the map when its parent HTML element is resized.
     */
    handleResize: function() {
      if (typeof NPMap.Map[NPMap.config.api] !== 'undefined') {
        NPMap.Map[NPMap.config.api].handleResize();
      }
      
      if (NPMap.InfoBox.visible) {
        NPMap.InfoBox.reposition();
      }
    },
    /**
     * Checks to see if a clustered layer has been added to the map.
     * @return {Boolean}
     */
    hasClusteredLayer: function() {
      hasClustered = false;
      
      if (NPMap.Layer) {
        NPMap.Layer.iterateThroughAllLayers(function(l) {
          if (l.type === 'NativeVectors' && l.clustered === true) {
            hasClustered = true;
          }
        });
      }
      
      return hasClustered;
    },
    /**
     * Checks to see if a tiled layer has been added to the map.
     * @return {Boolean}
     */
    hasTiledLayer: function() {
      hasTiled = false;

      if (NPMap.Layer) {
        NPMap.Layer.iterateThroughAllLayers(function(l) {
          if ((l.type === 'NativeVectors' && l.tiled) || (l.type === 'ArcGisServerRest' || l.type === 'CartoDb' || l.type === 'TileStream')) {
            hasTiled = true;
          }
        });
      }

      return hasTiled;
    },
    /**
     * Hides the progress bar.
     * @return null
     */
    hideProgressBar: function() {
      divProgressBar.childNodes[0].style.width = '100%';

      /*
      morpheus(divProgressBar, {
        complete: function() {
          divProgressBar.style.display = 'none';
          divProgressBar.style.opacity = 1;
        },
        duration: 1000,
        opacity: 0
      });
      */

      divProgressBar.style.display = 'none';
      divProgressBar.style.opacity = 1;
    },
    /**
     * Hides a shape.
     * @param {Object} shape The shape to hide.
     * @return null
     */
    hideShape: function(shape) {
      NPMap.Map[NPMap.config.api].hideShape(shape);
    },
    /**
     * Hides the tip.
     * @return null
     */
    hideTip: function() {
      if (divTip) {
        divTip.style.display = 'none';
      }
    },
    /**
     * Tests to see if a latLng is within the map's current bounds.
     * @param latLng {Object} The latitude/longitude object to test.
     * @return {Boolean}
     */
    isLatLngWithinMapBounds: function(latLng) {
      return NPMap.Map[NPMap.config.api].isLatLngWithinMapBounds(latLng);
    },
    /**
     * Tests the equivalency of two location strings.
     * @param {Object} latLng1 The first latLng object.
     * @param {Object} latLng2 The second latLng object.
     * @return {Boolean}
     */
    latLngsAreEqual: function(latLng1, latLng2) {
      var areEqual = false;

      if ((latLng1.lat.toFixed(7) === latLng2.lat.toFixed(7)) && (latLng1.lng.toFixed(7) === latLng2.lng.toFixed(7))) {
        areEqual = true;
      }

      return areEqual;
    },
    /**
     * Converts a base API lat/lng object to a NPMap lat/lng object.
     * @param {Object} latLng The lat/lng object.
     * @return {Object}
     */
    latLngFromApi: function(latLng) {
      return NPMap.Map[NPMap.config.api].latLngFromApi(latLng);
    },
    /**
     * Converts a NPMap lat/lng object to a base API latLng object.
     * @param {Object} latLng The lat/lng object.
     * @return {Object}
     */
    latLngToApi: function(latLng) {
      return NPMap.Map[NPMap.config.api].latLngToApi(latLng);
    },
    /**
     *
     */
    latLngToPixel: function(latLng) {
      return NPMap.Map[NPMap.config.api].latLngToPixel(this.latLngToApi(latLng));
    },
    /**
     * Turns meters into a zoom level. This function is not precise, as it is impossible to get precise meter scale values for the entire earth reprojected to web mercator.
     * @param {Number} meters
     * @return {Number}
     */
    metersToZoomLevel: function(meters) {
      var z;

      for (var i = 0; i < zoomScales.length; i++) {
        var zoom = i;
        
        if (meters >= zoomScales[i]) {
          if (zoomScales[i - 1]) {
            if (meters < zoomScales[i - 1]) {
              z = i + 1;
              break;
            }
          } else {
            z = zoom;
            break;
          }
        } else if (meters < zoomScales[zoomScales.length - 1]) {
          z = zoom;
          break;
        }
      }

      return z;
    },
    /**
     * Shows the notification.
     * @param {String} message
     * @param {String} title (Optional)
     * @param {String} type (Optional) Valid values are 'error', 'info', or 'success'.
     * @param {Number} interval (Optional)
     * @return null
     */
    notify: function(message, title, type, interval) {
      // TODO: This needs work. To reproduce bug, show a bunch of notifications one after the other, wait for them to start hiding, then try to show some more.
      var height,
          msg = createNotify(message, title, type);

      if (!divNotify) {
        divNotify = document.getElementById('npmap-notify');
      }

      msg.style.display = 'none';

      divNotify.appendChild(msg);

      height = Util.getOuterDimensions(msg).height;
      interval = interval || 3000;
      msg.style.top = -height + 'px';
      msg.style.display = 'block';

      morpheus(msg, {
        complete: function() {
          setTimeout(function() {
            activeNotificationMessagesHeight = activeNotificationMessagesHeight - height;

            morpheus(activeNotificationMessages, {
              complete: function() {
                activeNotificationMessages.splice(activeNotificationMessages.indexOf(msg), 1);
                msg.parentNode.removeChild(msg);
              },
              duration: 100,
              top: '-=' + height + 'px'
            });
          }, interval);
        },
        duration: 400,
        top: activeNotificationMessagesHeight + 'px'
      });
      activeNotificationMessages.push(msg);

      activeNotificationMessagesHeight = activeNotificationMessagesHeight + height;
    },
    /**
     * Opens the UI for a module.
     * @param {Object} el
     * @return null
     */
    openModule: function(el) {
      var id = el.id.replace('npmap-module-tab-', ''),
          module;

      for (var i = 0; i < NPMap.config.modules.length; i++) {
        var m = NPMap.config.modules[i];

        if (m.id === id) {
          module = m;
          break;
        }
      }

      if (divModules.style.display === '' || divModules.style.display === 'none') {
        divModuleTabs.style.display = 'none';
        divMap.style.left = '200px';
        divModules.style.display = 'block';
        divModulesClose.style.display = 'block';
      }
    },
    /**
     * Pans the map horizontally and/or vertically based on the pixels passed in.
     * @param {Object} pixels
     * @param {Function} callback (Optional)
     * @return null
     */
    panByPixels: function(pixels, callback) {
      NPMap.Map[NPMap.config.api].panByPixels(pixels, callback);
    },
    /**
     * Pans the map in a direction by a quarter of the current map viewport.
     * @param {String} direction The direction to pan the map in. Valid directions are 'east', 'north', 'south', and 'west'.
     * @return null
     */
    panInDirection: function(direction) {
      var divMapDimensions = Util.getOuterDimensions(divMap),
          h = divMapDimensions.height,
          me = this,
          w = divMapDimensions.width;

      switch (direction) {
        case 'east':
          me.panByPixels({
            x: - (w / 4),
            y: 0
          });
          break;
        case 'north':
          me.panByPixels({
            x: 0,
            y: h / 4
          });
          break;
        case 'south':
          me.panByPixels({
            x: 0,
            y: - (h / 4)
          });
          break;
        case 'west':
          me.panByPixels({
            x: w / 4,
            y: 0
          });
          break;
      }
    },
    /**
     * Converts a base API pixel object to its NPMap equivalent.
     * @param {Object} pixel
     * @return {Object}
     */
    pixelFromApi: function(pixel) {
      return NPMap.Map[NPMap.config.api].pixelFromApi(pixel);
    },
    /**
     * Converts a NPMap pixel object to its base API equivalent.
     * @param {Object} pixel
     * @return {Object}
     */
    pixelToApi: function(pixel) {
      return NPMap.Map[NPMap.config.api].pixelToApi(pixel);
    },
    /**
     * Converts a pixel object to a lat/lng object.
     * @param {Object} pixel
     * @return {Object}
     */
    pixelToLatLng: function(pixel) {
      return NPMap.Map[NPMap.config.api].latLngFromApi(NPMap.Map[NPMap.config.api].pixelToLatLng(NPMap.Map[NPMap.config.api].pixelToApi(pixel)));
    },
    /**
     * Removes a shape from the map.
     * @param {Object} shape The shape to remove from the map.
     * @return null
     */
    removeShape: function(shape) {
      NPMap.Map[NPMap.config.api].removeShape(shape);
    },
    /**
     * Sets the map bounds.
     * @param {Object} bounds
     * @return null
     */
    setBounds: function(bounds) {
      NPMap.Map[NPMap.config.api].setBounds(bounds);
    },
    /**
     * Sets the map cursor.
     * @param {String} cursor
     * @return null
     */
    setCursor: function(cursor) {
      if (typeof NPMap.Map[NPMap.config.api].setCursor === 'function') {
        NPMap.Map[NPMap.config.api].setCursor(cursor);
      } else {
        var div = this.getMapElement();

        if (div.style.cursor) {
          div.style.cursor.replace(/cursor:[^;]+/g, '');
        }

        div.style.cursor = cursor;
      }
    },
    /**
     * Sets the initial center of the map. This initial center is stored with the map, and is used by the setInitialExtent method, among other things.
     * @param {Object} center
     * @return null
     */
    setInitialCenter: function(center) {
      NPMap.Map[NPMap.config.api].setInitialCenter(this.latLngToApi(center));
    },
    /**
     * Sets the initial zoom of the map. This initial zoom is stored with the map, and is used by the setInitialExtent method, among other things.
     * @param {Number} zoom
     * @return null
     */
    setInitialZoom: function(zoom) {
      NPMap.Map[NPMap.config.api].setInitialZoom(zoom);
    },
    /**
     * Sets a marker's options.
     * @param {Object} marker The baseApi marker object.
     * @param {Object} options The options to set. Currently the valid options are: 'class', 'icon', 'label', 'visible', and 'zIndex'.
     * @return null
     */
    setMarkerOptions: function(marker, options) {
      NPMap.Map[NPMap.config.api].setMarkerOptions(marker, options);
    },
    /**
     * Sets the notify target to an HTML element other than the map div. This can only be called after NPMap has been initialized.
     * @param {Object} target
     * @return null
     */
    setNotifyTarget: function(target) {
      if (!divNotify) {
        divNotify = document.getElementById('npmap-notify');
      }

      target.appendChild(divNotify);
    },
    /**
     * Sets min and/or max zoom restrictions on the map.
     * @param {Object} restrictions
     * @return null
     */
    setZoomRestrictions: function(restrictions) {
      NPMap.Map[NPMap.config.api].setZoomRestrictions(restrictions);
    },
    /**
     * Shows the progress bar.
     * @param {Number} value (Optional) The value to start the progress bar at.
     * @return null
     */
    showProgressBar: function(value) {
      if (!divProgressBar) {
        divProgressBar = document.getElementById('npmap-progressbar');
      }

      divProgressBar.style.display = 'block';

      if (!value) {
        value = 0;
      }

      this.updateProgressBar(value);
    },
    /**
     * Shows a shape.
     * @param {Object} shape The shape to show.
     * @return null
     */
    showShape: function(shape) {
      NPMap.Map[NPMap.config.api].showShape(shape);
    },
    /**
     * Shows the tip.
     * @param {String} content
     * @param {Object} position
     * @return null
     */
    showTip: function(content, position) {
      var dimensions = Util.getOuterDimensions(divMap);

      if (!divTip) {
        divTip = document.getElementById('npmap-tip');
      }

      divTip.innerHTML = content;
      divTip.style.bottom = (dimensions.height - position.y) + 'px';
      divTip.style.right = (dimensions.width - position.x) + 'px';
      divTip.style.display = 'block';
    },
    /**
     * Zooms the map to a bounding box.
     * @param {Object} bounds
     * @return null
     */
    toBounds: function(bounds) {
      NPMap.Map[NPMap.config.api].toBounds(NPMap.Map[NPMap.config.api].boundsToApi(bounds));
    },
    /**
     * Toggles fullscreen mode on or off.
     * @return null
     */
    toggleFullScreen: function() {
      var baseApi = NPMap.Map[NPMap.config.api],
          currentCenter = baseApi.getCenter(),
          currentZoom = baseApi.getZoom(),
          divNpmap = document.getElementById('npmap');

      /*
      if (el.requestFullScreen || el.mozRequestFullScreen || el.webkitRequestFullScreen) {
        document.onfullscreenchange = function(e) {
          if (document.fullScreenElement || document.mozFullScreenElement || document.webkitFullScreenElement) {
            isFullScreen = true;
          } else {
            isFullScreen = false;
          }
        };

        if (isFullScreen) {
          if (el.cancelFullScreen) {
            el.cancelFullScreen();
          } else if (el.mozCancelFullScreen) {
            el.mozCancelFullScreen();
          } else {
            document.webkitCancelFullScreen();
          }

          isFullScreen = false;
        } else {
          if (el.requestFullScreen) {
            el.requestFullScreen();
          } else if (el.mozRequestFullScreen) {
            el.mozRequestFullScreen();
          } else {
            el.webkitRequestFullScreen();
          }

          isFullScreen = true;
        }
      } else {
        */
        var dimensionsWindow = Util.getWindowDimensions(),
            divMask = document.getElementById('npmap-fullscreen-mask');
        
        if (NPMap.InfoBox.visible) {
          currentCenter = baseApi.latLngToApi(NPMap.InfoBox.latLng);
        }

        Event.add('NPMap.Map', 'resized', function() {
          baseApi.centerAndZoom(currentCenter, currentZoom);
        }, true);

        if (isFullScreen) {
          document.body.style.overflow = 'visible';

          Util.removeClass(divNpmap, 'npmap-fullscreen-map');

          divNpmap.style.height = '100%';
          divNpmap.style.width = '100%';

          divNpmapParent.appendChild(divNpmap);

          divMask.style.display = 'none';
          document.getElementById('npmap-infobox').style.zIndex = '999999';
          isFullScreen = false;
        } else {
          if (!divMask) {
            var div = document.createElement('div');
            div.id = 'npmap-fullscreen-mask';
            document.body.appendChild(div);
            divMask = document.getElementById('npmap-fullscreen-mask');
          }
          
          document.body.style.overflow = 'hidden';
          divMask.style.display = 'block';
          
          Util.addClass(divNpmap, 'npmap-fullscreen-map');
          divNpmap.style.height = dimensionsWindow.height + 'px';
          divNpmap.style.width = dimensionsWindow.width + 'px';

          divMask.appendChild(divNpmap);

          document.getElementById('npmap-infobox').style.zIndex = '99999999999999';
          isFullScreen = true;
        }
      //}
    },
    /**
     * Zooms and/or pans the map to its initial extent.
     * @return null
     */
    toInitialExtent: function() {
      NPMap.Map[NPMap.config.api].toInitialExtent();
    },
    /**
     * Zooms the map to the extent of an array of lat/lng objects.
     * @param {Array} latLngs The array of lat/lng objects.
     * @return null
     */
    toLatLngs: function(latLngs) {
      var first = latLngs[0],
          bounds = {
            e: first.lng,
            n: first.lat,
            s: first.lat,
            w: first.lng
          };

      _.each(latLngs, function(latLng) {
        if (latLng.lat > bounds.n) {
          bounds.n = latLng.lat;
        }

        if (latLng.lat < bounds.s) {
          bounds.s = latLng.lat;
        }

        if (latLng.lng > bounds.e) {
          bounds.e = latLng.lng;
        }

        if (latLng.lng < bounds.w) {
          bounds.w = latLng.lng;
        }
      });

      this.toBounds(bounds);
    },
    /**
     * Zooms the map to the extent of an array of marker objects.
     * @param {Array} markers The array of marker objects.
     * @return null
     */
    toMarkers: function(markers) {
      NPMap.Map[NPMap.config.api].toMarkers(markers);
    },
    /**
     * Updates the map attribution.
     * @return null
     */
    updateAttribution: function() {
      var attribution,
          attrs = [],
          disclaimer = '<a href="http://www.nps.gov/npmap/disclaimer.html" target="_blank">Disclaimer</a>',
          divAttribution = document.getElementById('npmap-attribution'),
          me = this;

      if (NPMap.Map[NPMap.config.api]._attribution) {
        _.each(NPMap.Map[NPMap.config.api]._attribution, function(v) {
          attrs.push(v);
        });
      }

      if (NPMap.Layer) {
        _.each(NPMap.Layer.getVisibleLayers(), function(v) {
          if (typeof NPMap.Layer[v.type] !== 'undefined' && typeof NPMap.Layer[v.type].buildAttribution === 'function') {
            _.each(NPMap.Layer[v.type].buildAttribution(v), function(a) {
              attrs.push(a);
            });
          } else if (v.attribution) {
            _.each(v.attribution.split('|'), function(v2) {
              var credit = v2.replace(/^\s*/, '').replace(/\s*$/, '');

              if (_.indexOf(attrs, credit) === -1) {
                attrs.push(credit);
              }
            });
          }
        });
      }

      if (attrs.length > 0) {
        attrs.sort();

        attribution = attrs.join(' | ') + ' | ' + disclaimer;
      } else {
        attribution = disclaimer;
      }
      
      divAttribution.innerHTML = attribution;
      divAttribution.style.display = 'block';
    },
    /**
     * Updates the progress bar value.
     * @param {Number} value The value to update the progress bar with.
     * @return null;
     */
    updateProgressBar: function(value) {
      divProgressBar.childNodes[0].style.width = value + '%';
    },
    /**
     * Zooms the map to a zoom level.
     * @param {Number} zoom
     * @return null
     */
    zoom: function(zoom) {
      NPMap.Map[NPMap.config.api].zoom(zoom);
    },
    /**
     * Zooms the map in by one zoom level.
     * @return null
     */
    zoomIn: function() {
      NPMap.Map[NPMap.config.api].zoomIn();
    },
    /**
     * Zooms the map out by one zoom level.
     * @return null
     */
    zoomOut: function() {
      NPMap.Map[NPMap.config.api].zoomOut();
    }
  };
});