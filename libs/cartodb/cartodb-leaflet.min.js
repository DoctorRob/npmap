L.CartoDBLayer=L.TileLayer.extend({version:"0.55",includes:L.Mixin.Events,options:{query:"SELECT * FROM {{table_name}}",opacity:0.99,auto_bound:!1,attribution:"CartoDB",debug:!1,visible:!0,added:!1,tiler_domain:"cartodb.com",tiler_port:"80",tiler_protocol:"http",sql_domain:"cartodb.com",sql_port:"80",sql_protocol:"http",extra_params:{},cdn_url:null,subdomains:"abc"},initialize:function(a){L.Util.setOptions(this,a);if(!a.table_name||!a.map){if(a.debug)throw"cartodb-leaflet needs at least a CartoDB table name and the Leaflet map object :(";}else a.auto_bound&&this.setBounds()},onAdd:function(){this._addLayer();this.fire("added");this.options.added=!0},onRemove:function(){this._remove();this.options.added=!1},setOpacity:function(a){if(this.options.added)if(isNaN(a)||1<a||0>a){if(this.options.debug)throw a+" is not a valid value";}else this.options.opacity=a,this.options.visible&&(this.layer.setOpacity(1==a?0.99:a),this.fire("updated"));else if(this.options.debug)throw"the layer is not still added to the map";},setQuery:function(a){if(this.options.added)if(isNaN(a))this.options.query=a,this._update();else{if(this.options.debug)throw a+" is not a valid query";}else if(this.options.debug)throw"the layer is not still added to the map";},setStyle:function(a){if(this.options.added)if(isNaN(a))this.options.tile_style=a,this._update();else{if(this.options.debug)throw a+" is not a valid style";}else if(this.options.debug)throw"the layer is not still added to the map";},setInteractivity:function(a){if(this.options.added)if(isNaN(a))this.options.interactivity=a,this._update();else{if(this.options.debug)throw a+" is not a valid setInteractivity value";}else if(this.options.debug)throw"the layer is not still added to the map";},setLayerOrder:function(){},setInteraction:function(a){if(this.options.added)if(!1!==a&&!0!==a){if(this.options.debug)throw a+" is not a valid setInteraction value";}else{if(this.interaction)if(a){var b=this;this.interaction.on("on",function(a){b._bindWaxOnEvents(b.options.map,a)});this.interaction.on("off",function(){b._bindWaxOffEvents()})}else this.interaction.off("on"),this.interaction.off("off")}else if(this.options.debug)throw"the layer is not still added to the map";},setAttribution:function(a){if(this.options.added)if(isNaN(a))this.options.map.attributionControl.removeAttribution(this.options.attribution),this.options.attribution=a,this.options.map.attributionControl.addAttribution(this.options.attribution),this.layer.options.attribution=this.options.attribution,this.tilejson.attribution=this.options.attribution,this.fire("updated");else{if(this.options.debug)throw a+" is not a valid attribution";}else if(this.options.debug)throw"The layer is still not added to the map";},setOptions:function(a){if(this.options.added)if("object"!=typeof a||a.length){if(this.options.debug)throw a+" options has to be an object";}else L.Util.setOptions(this,a),this._update();else if(this.options.debug)throw"the layer is not still added to the map";},isVisible:function(){return this.options.visible},isAdded:function(){return this.options.added},hide:function(){if(this.options.added)if(this.options.visible)this.layer.setOpacity(0),this.setInteraction(!1),this.options.visible=!1,this.fire("hidden");else{if(this.options.debug)throw"the layer is already hidden";}else if(this.options.debug)throw"the layer is not still added to the map";},show:function(){if(this.options.added)if(this.options.visible){if(this.options.debug)throw"the layer is already shown";}else this.layer.setOpacity(this.options.opacity),this.setInteraction(!0),this.options.visible=!0,this.fire("shown");else if(this.options.debug)throw"the layer is not still added to the map";},_remove:function(){this.setInteraction(!1);this.layer.off("loading").off("load");this.interaction&&this.interaction.remove();this.options.map.removeLayer(this.layer);this.fire("removed")},_update:function(){this._remove();this._addLayer();this.fire("updated")},setBounds:function(a){var b=this,c="",c=a?a:this.options.query;reqwest({url:this._generateCoreUrl("sql")+"/api/v2/sql/?q="+escape("SELECT ST_XMin(ST_Extent(the_geom)) as minx,ST_YMin(ST_Extent(the_geom)) as miny,ST_XMax(ST_Extent(the_geom)) as maxx,ST_YMax(ST_Extent(the_geom)) as maxy from ("+c.replace(/\{\{table_name\}\}/g,this.options.table_name)+") as subq"),type:"jsonp",jsonpCallback:"callback",success:function(a){if(null!=a.rows[0].maxx){var c=a.rows[0],f=c.maxx,g=c.maxy;a=c.minx;c=c.miny;a=-179>a?-179:179<a?179:a;c=-85.0511>c?-85.0511:85.0511<c?85.0511:c;f=new L.LatLng(-85.0511>g?-85.0511:85.0511<g?85.0511:g,-179>f?-179:179<f?179:f);a=new L.LatLng(c,a);a=new L.LatLngBounds(f,a);b.options.map.fitBounds(a)}},error:function(a,b){if(this.options.debug)throw"Error getting table bounds: "+b;}})},_addLayer:function(){var a=this;this.tilejson=this._generateTileJson();this.layer=(new wax.leaf.connector(this.tilejson)).on("loading",function(){a.fire("loading",this)}).on("load",function(){a.fire("load",this)});this._checkTiles();this.options.map.addLayer(this.layer,!1);this.options.interactivity&&(this.interaction=wax.leaf.interaction().map(this.options.map).tilejson(this.tilejson).on("on",function(b){a._bindWaxOnEvents(a.options.map,b)}).on("off",function(){a._bindWaxOffEvents()}))},_bindWaxOnEvents:function(a,b){var c=this._findPos(a,b),c=a.layerPointToLatLng(c);switch(b.e.type){case "mousemove":if(this.options.featureOver)return this.options.featureOver(b.e,c,{x:b.e.clientX,y:b.e.clientY},b.data);if(this.options.debug)throw"featureOver function not defined";break;case "click":if(this.options.featureClick)this.options.featureClick(b.e,c,{x:b.e.clientX,y:b.e.clientY},b.data);else if(this.options.debug)throw"featureClick function not defined";break;case "touchend":if(this.options.featureClick)this.options.featureClick(b.e,c,{x:b.e.clientX,y:b.e.clientY},b.data);else if(this.options.debug)throw"featureClick function not defined";}},_bindWaxOffEvents:function(){if(this.options.featureOut)return this.options.featureOut&&this.options.featureOut();if(this.options.debug)throw"featureOut function not defined";},_generateTileJson:function(){var a=this._generateTileUrls(),b=a.grid_url;if(-1!=a.grid_url.indexOf("{s}")){var b=[],c=this.options.subdomains;"[object Array]"!==Object.prototype.toString.call(c)&&c.split("");for(var d=0;d<c.length;d++)b.push(a.grid_url.replace(/\{s\}/g,c[d]))}return{blankImage:NPMap.config.server+"/resources/img/blank-tile.png",tilejson:"1.0.0",scheme:"xyz",attribution:this.options.attribution,tiles:[a.tile_url],grids:b,tiles_base:a.tile_url,grids_base:b,opacity:this.options.opacity,formatter:function(a,b){return b}}},_parseUri:function(a){var b="source protocol authority userInfo user password host port relative path directory file query anchor".split(" ");a=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/.exec(a);for(var c={},d=14;d--;)c[b[d]]=a[d]||"";c.queryKey={};c[b[12]].replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c.queryKey[b]=d)});return c},_addUrlData:function(a,b){a+=this._parseUri(a).query?"&":"?";return a+b},_generateCoreUrl:function(a){return this.options.cdn_url?this.options.cdn_url:"sql"==a?this.options.sql_protocol+"://"+(this.options.user_name?this.options.user_name+".":"")+this.options.sql_domain+(""!=this.options.sql_port?":"+this.options.sql_port:""):this.options.tiler_protocol+"://"+(this.options.user_name?this.options.user_name+".":"")+this.options.tiler_domain+(""!=this.options.tiler_port?":"+this.options.tiler_port:"")},_generateTileUrls:function(){var a=this._generateCoreUrl("tiler"),b=a+"/tiles/"+this.options.table_name+"/{z}/{x}/{y}",c=b+".png",d=b+".grid.json";if(this.options.query)var e=encodeURIComponent(this.options.query.replace(/\{\{table_name\}\}/g,this.options.table_name)),e=e.replace(/%7Bx%7D/g,"{x}").replace(/%7By%7D/g,"{y}").replace(/%7Bz%7D/g,"{z}"),e="sql="+e,c=this._addUrlData(c,e),d=this._addUrlData(d,e);for(_param in this.options.extra_params)c=this._addUrlData(c,_param+"="+this.options.extra_params[_param]),d=this._addUrlData(d,_param+"="+this.options.extra_params[_param]);this.options.tile_style&&(e="style="+encodeURIComponent(this.options.tile_style.replace(/\{\{table_name\}\}/g,this.options.table_name)),c=this._addUrlData(c,e),d=this._addUrlData(d,e));this.options.interactivity&&(e="interactivity="+encodeURIComponent(this.options.interactivity.replace(/ /g,"")),c=this._addUrlData(c,e),d=this._addUrlData(d,e));return{core_url:a,base_url:b,tile_url:c,grid_url:d}},_findPos:function(a,b){var c=curtop=0,d=a._container;if(d.offsetParent){do c+=d.offsetLeft,curtop+=d.offsetTop;while(d=d.offsetParent);return a.containerPointToLayerPoint(new L.Point((b.e.clientX||b.e.changedTouches[0].clientX)-c,(b.e.clientY||b.e.changedTouches[0].clientY)-curtop))}return a.mouseEventToLayerPoint(b.e)},_checkTiles:function(){var a=this;new Image;var b=this._generateTileUrls();b.tile_url=b.tile_url.replace(/\{z\}/g,4).replace(/\{x\}/g,6).replace(/\{y\}/g,6);b.grid_url=b.grid_url.replace(/\{z\}/g,4).replace(/\{x\}/g,6).replace(/\{y\}/g,6);reqwest({method:"get",url:b.grid_url.replace(/\{s\}/g,"a"),type:"jsonp",jsonpCallback:"callback",jsonpCallbackName:"grid",success:function(){clearTimeout(c)},error:function(b,c){a.interaction&&a.interaction.remove();if(a.options.debug)throw"There is an error in your query or your interaction parameter";a.fire("layererror",c)}});var c=setTimeout(function(){clearTimeout(c);if(a.options.debug)throw"There is an error in your query or your interaction parameter";a.fire("layererror","There is a problem in your SQL or interaction parameter")},2E3)}});